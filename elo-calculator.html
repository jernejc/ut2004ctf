<html>
<div id="data"></div>
<script type="text/javascript" src="database.js"></script>
<script type="text/javascript" src="/database.js"></script>
<script>
	function getSortedKeys(obj) {
		var keys = keys = Object.keys(obj);
		return keys.sort(function(a,b){return obj[b]-obj[a]});
	}
	
    var buff = '',
	    players = getPlayers(),
		games = getGames(),
		oldStats = Object.assign({}, players);
	
    var calculateTeamTotalElo = function(team) {

        var sum = 0;

        for (var k in team) {
            sum += players[team[k]];
        }

        return sum;
    };

    var isRedTeamPlayer = function(game, playerName) {

        for (var k in game.red) {
            if (game.red[k] === playerName) {
                return true;
            }
        }

        return false;
    };
	
	var playedGames = [],
	    darkHorses = [],
		playerMapStats = [];
	
	for (i in players) {
		darkHorses[i] = 0;
		playedGames[i] = 0;
		playerMapStats[i] = { wins: [], loses: [] };
	}
	
    var getPlayerEloInGame = function(playerName, game) {

        var oldElo = players[playerName],
            myTeamScore,
            opTeamScore,
            myTeamElo,
            opTeamElo,
            Sa,
			isWin,
			date = new Date(game.date.split('.').reverse().join('-')).getTime(),
			minDarkHorseDay = 30,
			minDarkHorseTs = Math.ceil((new Date().getTime()) - minDarkHorseDay * 60 * 60 * 24 * 1000);

        if (typeof players[playerName] === "undefined") {
            alert('Unknow player ' + playerName);
        }

        if (isRedTeamPlayer(game, playerName)) {
            myTeamScore = game.redScore;
            opTeamScore = game.blueScore;
            myTeamElo = calculateTeamTotalElo(game.red);
            opTeamElo = calculateTeamTotalElo(game.blue);
        } else {
            myTeamScore = game.blueScore;
            opTeamScore = game.redScore;
            myTeamElo = calculateTeamTotalElo(game.blue);
            opTeamElo = calculateTeamTotalElo(game.red);
        }

        Sa = 0;
		K = oldElo / 400;
		isWin = myTeamScore > opTeamScore;

		if (isWin) {
		
			if (typeof playerMapStats[playerName].wins[game.map] === 'undefined') {
				playerMapStats[playerName].wins[game.map] = 0;
			}
		
			++ playerMapStats[playerName].wins[game.map];
			
		} else {
			
			if (typeof playerMapStats[playerName].loses[game.map] === 'undefined') {
				playerMapStats[playerName].loses[game.map] = 0;
			}
		
			++ playerMapStats[playerName].loses[game.map];			
		}

		++playedGames[playerName];
		
        if (opTeamElo >= myTeamElo && isWin) {
			
			Sa += 4 * K;
			
			if (date >= minDarkHorseTs) {	
				++darkHorses[playerName];
			}
			
		} else if (myTeamElo > opTeamElo && isWin) {
			Sa += K;
		} else if (opTeamElo >= myTeamElo && !isWin) {
			Sa -= K;
		} else {
			Sa -= 4 * K;
		}

        return oldElo + Sa;
    };

    var updateTeamsEloInGame = function(game) {

        var playersInGame = game.red.concat(game.blue),
            eloResults = [];

        for (var i in playersInGame) {
            eloResults[playersInGame[i]] = getPlayerEloInGame(playersInGame[i], game);
        }

        for (var playerName in eloResults) {
            players[playerName] = eloResults[playerName];
        }
    };

    for (i in games) {
        updateTeamsEloInGame(games[i]);
    }

    function getSortedKeys(obj) {
        var keys = keys = Object.keys(obj);
        return keys.sort(function(a, b) {
            return obj[b] - obj[a]
        });
    }

    var sortedPlayers = getSortedKeys(players);

    var winRates = [];

    for (i in players) {
        winRates[i] = {
            wins: 0,
            loses: 0,
            avg: 0
        };
    }

    var updatePlayerWinRateInGame = function(playerName, game) {

        if (isRedTeamPlayer(game, playerName)) {
            if (game.redScore > game.blueScore) {
                ++winRates[playerName].wins;
            } else {
                ++winRates[playerName].loses;
            }
        } else {
            if (game.blueScore > game.redScore) {
                ++winRates[playerName].wins;
            } else {
                ++winRates[playerName].loses;
            }
        }
    };

    var updateTeamsWinRateInGame = function(game) {

        var playersInGame = game.red.concat(game.blue);

        for (var i in playersInGame) {
            updatePlayerWinRateInGame(
                playersInGame[i],
                game
            );
        }
    };

    for (i in games) {
        updateTeamsWinRateInGame(games[i]);
    }

    for (i in winRates) {
        winRates[i].avg = Math.ceil((winRates[i].wins / (winRates[i].wins + winRates[i].loses)) * 100);
    }

	var facts = {},
		redWins = 0,
		blueWins = 0;
	
	// calculate red/blue %
	for (i in games) {
		if (games[i].redScore > games[i].blueScore) {
			++ redWins;
		} else {
			++ blueWins;
		}
	}

	// calculate win/lose streak
	var winningStreak = [],
		losingStreak = [],
		j;
	
	for (i in players) {
		winningStreak[i] = { current: 0, max: 0 };
		losingStreak[i] = { current: 0, max: 0 };
	}
	
	for (i in games) {
		
		var gamePlayers = games[i].red.concat(games[i].blue);
		
		for (j in gamePlayers) {
			
			var playerName = gamePlayers[j],
				redWin = games[i].redScore > games[i].blueScore,
				isRedPlayer = games[i].red.includes(playerName);
			
			if ((redWin && isRedPlayer) || (!redWin && !isRedPlayer)) {
				
				if (++winningStreak[playerName].current > winningStreak[playerName].max) {
					winningStreak[playerName].max = winningStreak[playerName].current;
				}
				
				losingStreak[playerName].current = 0;
				
			} else {
				
				if (++losingStreak[playerName].current > losingStreak[playerName].max) {
					losingStreak[playerName].max = losingStreak[playerName].current;
				}
				
				winningStreak[playerName].current = 0;
			}
		}
	}
	
	var bestWinningStreak = 0,
		bestWinningStreakPlayer;
	
	for (i in winningStreak) {
		if (winningStreak[i].max > bestWinningStreak) {
			bestWinningStreak = winningStreak[i].max;
			bestWinningStreakPlayer = i;
		}
	}
	
	var worstLosingStreak = 0,
		worstLosingStreakPlayer;
	
	for (i in losingStreak) {
		if (losingStreak[i].max > worstLosingStreak) {
			worstLosingStreak = losingStreak[i].max;
			worstLosingStreakPlayer = i;
		}
	}
		
	facts.redWinRate = (redWins / (blueWins + redWins)) * 100;
	
	var darkHorseValue = 0,
		darkHorsePlayer;
		
	for (i in darkHorses) {
		
		var current = playedGames[i] > 0 ? darkHorses[i] / playedGames[i] : 0;
		
		if (current > darkHorseValue) {
			darkHorsePlayer = i;
			darkHorseValue = current;
		}
	}
	
	var bestMaps = [],
		worstMaps = [];
		
	for (i in playerMapStats) {
		bestMaps[i] = getSortedKeys(playerMapStats[i].wins)[0];
		worstMaps[i] = getSortedKeys(playerMapStats[i].loses)[0];
	}
	
	console.log(bestMaps, worstMaps);
	
	var data = document.getElementById('data');

	buff = '<table style="border: #ccc solid 1px; border-collapse: collapse;">'
	+ '<tbody><tr>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Rank</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Name</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Elo-Rating</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Rank 01.05</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Wins</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Loses</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Wins</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Best Streak</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Worst Streak</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Best map</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Worst map</th>'
	+ '</tr></tbody>';
	
    for (i in sortedPlayers) {
	
		var playerName = sortedPlayers[i];
	
		buff += '<tr>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px; text-align: right;">' + (parseInt(i, 10) + 1) + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + playerName + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px; font-weight: bold;">' + Math.ceil(players[playerName]) + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + Math.ceil(oldStats[playerName]) + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + winRates[playerName].wins + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + winRates[playerName].loses + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + winRates[playerName].avg + '%</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + winningStreak[playerName].max + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + losingStreak[playerName].max + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + (typeof bestMaps[playerName] === 'undefined' ? '?' : bestMaps[playerName]) + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + (typeof worstMaps[playerName] === 'undefined' ? '?' : worstMaps[playerName]) + '</td>';
		buff += '</tr>';
    }
	
	buff += '</table>';
	
	buff += '<br /><br /><h4>Facts</h4>';
	buff += '<p>Overall matches played: <b>' + games.length + '</b></p>';
	buff += '<p>Overall, Red - Blue win-rate is <b>' + Math.ceil(facts.redWinRate) + '% - ' + (100 - Math.ceil(facts.redWinRate)) + '%</b></p>';
	buff += '<p>Best winning streak has player <b>' + bestWinningStreakPlayer + '</b> (' + bestWinningStreak + ')</p>';
	buff += '<p>Worst losing streak has player <b>' + worstLosingStreakPlayer + '</b> (' + worstLosingStreak + ')</p>';
	buff += '<p>Dark horse: <b>' + (typeof darkHorsePlayer === 'undefined' ? '?' : darkHorsePlayer) + '</b></p>';
	
	buff += '<br /><h4>Elo-rank calculation rules:</h4>';
	buff += 'New Elo-rating = Old Elo-rating + Pts * (Old Elo-rating / 400)<br /><br />';
	buff += 'Pts = +4 points for winning against a team with the same or greater Elo-rating than your team.<br />';
	buff += 'Pts = +1 points for winning against a team with the lower than your team.<br />';
	buff += 'Pts = -1 points for losing against a team with the same or greater Elo-rating than your team.<br />';
	buff += 'Pts = -4 points for losing against a team with the lower Elo-rating than your team.<br /><br />';
	
	var mapsGames = [];
	
	for (i in games) {
	
		if (typeof mapsGames[games[i].map] === 'undefined') {
			mapsGames[games[i].map] = 0;
		}
		
		++mapsGames[games[i].map];
	}
	
	var sortedMapsGames = getSortedKeys(mapsGames);
	
	buff += '<h4>Maps</h4>';
	
	buff += '<table style="border: #ccc solid 1px; border-collapse: collapse;">'
	+ '<tbody><tr>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Name</th>'
	+ '<th style="border: #ccc solid 1px; padding: 5px 10px;">Games</th>'
	+ '</tr></tbody>';
	
    for (i in sortedMapsGames) {
		buff += '<tr>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px; text-align: right;">' + sortedMapsGames[i] + '</td>';
		buff += '<td style="border: #ccc solid 1px; padding: 5px 10px;">' + mapsGames[sortedMapsGames[i]] + '</td>';
		buff += '</tr>';
    }
	
	buff += '</table>';
	
	buff += '<br /><br /><br />';
	
	data.innerHTML = buff;

</script>
</html>